- name: add group for kafka
  group: 
    name: '{{pl_group}}'
    gid:  '{{pl_gid}}'

- name: add user for kafka
  user: 
    name:  '{{pl_user}}'
    group: '{{pl_group}}'
    uid:   '{{pl_uid}}'
    home:  '{{pl_home}}'
    shell: /bin/bash

- name: make floder for use 
  file: 
    path:  '{{item.path}}'
    owner: '{{item.owner}}'
    group: '{{item.group}}'
    mode: 0755 
    state: '{{item.state}}'
  with_items:
    - { path: '{{pl_deploy_home}}'    ,owner: 'root'       ,group: 'root'        ,state: 'directory' }
    - { path: '{{pl_home}}/kafka'     ,owner: '{{pl_user}}',group: '{{pl_group}}',state: 'directory' }
    - { path: '{{pl_home}}/kafka/logs',owner: '{{pl_user}}',group: '{{pl_group}}',state: 'directory' }
    
- name: extract kafka source packages
  unarchive: src='{{item.src}}' dest='{{item.dest}}'
  with_items:
    - { src: 'kafka_{{pl_kafka_version}}.tgz'         ,dest: '{{pl_home}}/kafka' }
    - { src: 'jdk-{{pl_jdk_version}}-linux-x64.tar.gz',dest: '{{pl_home}}' }

- name: change floder owner
  file: path='{{pl_home}}/jdk{{pl_jdk_version}}' owner='{{pl_user}}' group='{{pl_group}}' recurse=yes 
  
- name: config kafka
  template: src='{{item.src}}' dest='{{item.dest}}'
  with_items:
    - { src: 'server.properties.j2',dest: '{{pl_home}}/kafka/kafka_{{pl_kafka_version}}/config/server.properties' }
    - { src: 'kafka.service.j2',    dest: '/lib/systemd/system/kafka.service' }

- name: firewall kafka
  firewalld: port={{item}}/tcp permanent=true state=enabled
  with_items:
    - '{{pl_kafka_port}}'
    - '{{pl_kafka_jmx_port}}'
  
- name: change floder kafka
  file: path='{{pl_home}}/kafka' owner='{{pl_user}}' group='{{pl_group}}' recurse=yes

- name: start  kafka
  systemd: name='{{item.name}}' state='{{item.state}}' enabled=yes
  with_items:
    - { name: 'firewalld',state: 'reloaded' }
    - { name: 'kafka',state: 'started' }